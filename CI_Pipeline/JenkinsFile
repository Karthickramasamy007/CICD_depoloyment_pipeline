pipeline {

  agent {
    kubernetes { // Kubernetes plugin
      cloud 'my-kind-kubernetes' // plugin cloud configuration name. Here is where jenkins controller and following containers are running.
      yamlFile 'pipeline/builder.yaml'
    }
  }
  

  environment {
        GOOGLE_PROJECT_ID = 'dev-demo-proj-1-id'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/Karthickramasamy007/gcp-infra-via-terraform', branch: 'main'
            }
        }

        stage('Check Terraform Version') {
            steps {
                container('terraform') { // This references container name in the K8s yaml above to run the below command in pod.
                    sh 'terraform --version'
                    sh 'terraform init'
                    sh 'terraform plan' 
                    sh 'terraform apply -auto-approve' 
                }
            }
        }

        stage('Clean Up') {
            steps {
                container('terraform')  {
                    sh 'terraform workspace select default || terraform workspace new default'
                    sh 'terraform destroy -auto-approve'
                }
            }
        }
    }

    post {
        success {
            echo 'Terraform deployment successful!'
        }
        failure {
            echo 'Terraform deployment failed!'
        }
        always {
            echo 'Cleaning up...'
        }
    }
}
